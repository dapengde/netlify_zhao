<meta charset="utf-8">

**B1：R 初级概览**
 赵鹏






# 热身


![前](https://slides.yihui.name/gif/latex-tweak.gif height=260px)![后](https://slides.yihui.name/gif/git-push-force.gif height=260px)

<center><big>May the foRce be with you!</br>愿原力与你同在</big></center>


# 目标

1. 搭建 R 环境
2. 学习 R 基本操作
3. 使用 R 处理自己的数据

# 准备

## 安装

### R 语言包

- 下载地址：<https://cran.r-project.org>

以 Windows 操作系统为例：

1. 打开官网下载页面：<https://cran.r-project.org> => Download R for Windows => base
2. 点击顶端第二行的 ‘Download R x.x.x for Windows’ (x.x.x 是版本号，例如 4.0.3)，开始下载。
3. 下载完毕后，双击得到的文件，按默认设置不断点击“下一步” 完成安装。

### RStudio
 
- 下载地址：<https://www.rstudio.com/products/rstudio/download/#download>

以 Windows 操作系统为例：

1. 打开上述下载页面。
2. 点击 ‘DOWNLOAD RSTUDIO FOR WINDOWS’，开始下载。
3. 下载完毕后，双击得到的文件，按默认设置不断点击“下一步” 完成安装。

### 其它推荐软件

- [Notepad++](https://notepad-plus-plus.org/download)
- [git](https://git-scm.com/downloads)

## R 的用途/你的期望

- 统计计算
- 各类数据的处理
- 作图；数据可视化
- 自动和批量任务
- 在线交互应用
- 可重复性研究
- 协作

!!! 
    罗杰：对我来说，99 % 的事情都能由 R 完成。但是让人郁闷的是，想订个披萨饼的时候，我还是得抓起电话。
    
    道格：美国很多披萨饼连锁店提供网上预订服务啊。R有互联网模块，所以，披萨预订函数的出现只是个早晚问题。
    
    --- *R fortunes*， 2004 年 6 月

## R 入门的三大障碍

1. 老板不支持。解决方案：无解。
2. 数据不支持。解决方案：.csv + UTF-8。
3. 中文不支持。解决方案：安装到英文路径 + `R_HOME/etc/Rconsole language = en` + `Sys.setlocale("LC_ALL","Chinese")`

# 基本操作

## 使用 RStudio

### 界面布局

![](https://pzhao.org/image/software-rstudio.jpg)


### 快捷键

- 运行代码：ctrl + enter
- 自动补全：TAB
- 查看帮助：F1
- 更多快捷键: shift + alt + k

### 项目（project）

- File - New project - New directory - New project
- 永远在项目里管理 R 代码和其它文件。
- 永远从 .Rproj 文件开始工作。



## 数学运算

### 基本计算

~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
+ - * / ^
c()
[]
round()
sqrt()
exp()
log()
log10()
=
<-  (alt + _)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### 注释（Comment）


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
# 一条注释以 # 开头.
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip: 简单计算
    
    1. 计算半径为 10 米、20 米、30 米、40 米、60 米的圆形周长和面积。
    2. 计算自然对数的底 *e*。
    3. 假设 $y = \frac{ax}{e} + b$, $a = 3.2$, $b = 98$, 计算当 $x = 0.2, 2, 20, 200$ 时 $y$ 的值。
    4. 为上述练习的代码添加注释。

# 数据

## 读入数据

### 示例数据


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
write.csv(airquality, 'aq.csv')
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### 手动录入


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
df1 <- data.frame(age = c(21, 31, 23, 40, 36),
                  gender = c('f', 'm', 'm', 'f', 'f'))
df1
~~~~~~~~~~~~~~~~~~~~~~~~~~~

~~~~~~~~~~~~~~~~~~~~~~~~~~~
##   age gender
## 1  21      f
## 2  31      m
## 3  23      m
## 4  40      f
## 5  36      f
~~~~~~~~~~~~~~~~~~~~~~~~~~~

~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
require(tibble)
df2 <- tribble(
  ~age, ~gender,
  76,    'f',
  79,    'm',
  85,    'f',
  93,    'f',
  88,    'm'
)
df2
~~~~~~~~~~~~~~~~~~~~~~~~~~~

~~~~~~~~~~~~~~~~~~~~~~~~~~~
## # A tibble: 5 x 2
##     age gender
##   <dbl> <chr> 
## 1    76 f     
## 2    79 m     
## 3    85 f     
## 4    93 f     
## 5    88 m
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### 从文件读取


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
aq <- read.csv('aq.csv')
aq
~~~~~~~~~~~~~~~~~~~~~~~~~~~


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
aq2 <- readr::read_csv('aq.csv')
~~~~~~~~~~~~~~~~~~~~~~~~~~~

读入数据时中文支持的三个技巧：

1. `Sys.setlocale("LC_ALL","Chinese")`
2. 数据以 UTF-8 编码保存。
3. 读取时设定 `fileEncoding = "UTF-8"` 或 `readr::read_csv()`.

## 数据结构

- 下标（indexing）


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
$
[, ]
~~~~~~~~~~~~~~~~~~~~~~~~~~~

- 向量（vector）


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
x <- aq$Ozone
x
str(x)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

- 数据框（data frame）


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
str(aq)
class(aq)
is.data.frame(aq)
dim(aq)
rownames(aq)
colnames(aq)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

## 基本统计


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
length(aq$Solar.R)
sum(aq$Solar.R)
sum(aq$Solar.R, na.rm = TRUE)
sum(aq$Solar.R, na.rm = TRUE) / length(aq$Solar.R)
mean(aq$Ozone)
o3mean <- mean(aq$Ozone)
o3mean
aq$ozone2 <- aq$Ozone - o3mean
~~~~~~~~~~~~~~~~~~~~~~~~~~~

~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
max()
min()
range()
median()
sd()
var()
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip: 每季度收入数据
    
    1. 将每季度收入数据 `freeny` 保存为本地文件，并读取赋值给一个叫 `income` 的变量。 
    2. 给出列数和行数。
    3. 列出 1964 年第 1 季度的各项数据。
    3. 列出各季度的价格指数（`price.index`），并赋值给一个新向量 `pr`。
    4. 计算每列数据的平均值，最大值，最小值，中位数。
    5. 为数据新增两列：一列为年份，列名称为 `year`；另一列为季度数（不含年份），名称为 `season`。

## 分组（Grouping）


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
aq$Month <- as.factor(aq$Month)
str(aq)
tapply(aq$Ozone, aq$Month, mean)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip: 分组计算 `income` 数据
    
    1. 计算 1964 年的平均价格指数 `price.index`。
    1. 计算各年的平均价格指数 `price.index`。
    1. 计算跨年的各季度平均价格指数。

## 数据概览


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
summary(aq)
plot(aq)
~~~~~~~~~~~~~~~~~~~~~~~~~~~



~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
new_pkg <- c('ggplot2', 'GGally')
install.packages(new_pkg)
library('GGally')
ggpairs(aq[, 2:5])
ggpairs(aq[, 2:6], aes(color = Month, alpha = 0.2))
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip:  `income` 数据总结
    
    1. 数据总结。y 的中位数是多少？最大值、最小值各是多少？分别发生在哪年哪季度？
    2. 做配对散点图。各要素之间有何关联？

## 保存

- 数据


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
write.csv(aq, 'aq2.csv')
~~~~~~~~~~~~~~~~~~~~~~~~~~~

- 图


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
pdf('aq.pdf')
ggpairs(aq[, 2:6], aes(color = Month, alpha = 0.2))
dev.off()
~~~~~~~~~~~~~~~~~~~~~~~~~~~

- 代码

- 工作空间

- 历史记录

!!! Tip: 保存 `income` 相关数据
    
    将 `income` 数据、图、练习代码、工作空间和历史记录分别保存到项目目录下的 `data`、`image`、`script`、`wd`、`history` 文件夹。

# 编程基础

## 分支


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
1 > 2
1 <= 2
hour <- 12
if(hour == 12) {
  print('Time for lunch. Go!')
}

o3 <- 10
if(o3 < o3mean) {
  print('Low.')
} else {
  print('High.')
}

lh <- ifelse(o3 < o3mean, 
             print('low'), print('high'))

aq$test <- ifelse(aq$Ozone > o3mean, 
                  'high', 'low')
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip: `income`数据分支计算
    
    1. 为 `income`数据新增一列`y.level`，当 $y < 9.1$ 时为 1, 否则为 0。
    1. 为 `income`数据新增一列`color`，当 market.potential $\geq$ 13 时为 `red`, 否则为 `green`。

## 循环


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
x <- 1:10
x

for(i in x){
  print('Hello World!')
}

for(i in x){
  print(i)
}

for(i in x){
  dir.create(as.character(i))
}


for(i in x){
  unlink(as.character(i), recursive = TRUE, force = TRUE)
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip:
    用循环函数来计算半径为 10 米、20 米、30 米、40 米、60 米的圆形周长和面积。

# 作图

## 基础作图

### `plot()` 函数



~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
plot(aq$Temp)
plot(aq$Temp, aq$Ozone)
plot(aq$Temp, aq$Ozone, col = 'red')
plot(aq$Temp, aq$Ozone, col = ifelse(aq$Month == 6, 'red', 'blue'))
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip: 为 `income` 数据作图
    
   1. 绘制收入水平 `income.level` 随时间的变化图。
   1. 绘制以收入水平 `income.level` 为横轴、价格指数 `price.index` 为纵轴的散点图。
   1. 阅读 `plot()` 函数的帮助信息，回答：如何更改数据点的形状及大小？
   1. 将上图里的数据点改为实心圆点，并且：当一个数据点对应的 market.potential $\geq$ 13 时画成红色, 否则为绿色；每个点的大小由对应的收入水平值来决定。
   1. 如何更改坐标轴的名称？将上图的坐标轴名称改为中文。

### 常见作图函数

| 函数           | 用途                 |
| -------------- | -------------------- |
| `plot()`       | 主要用作散点图       |
| `pairs()`      | 散点图矩阵           |
| `symbols()`    | 气泡图               |
| `hist()`       | 直方图               |
| `curve()`      | 函数曲线图           |
| `barplot()`    | 柱状图               |
| `boxplot()`    | 箱式图               |
| `coplot()`     | 条件散点图           |
| `dotchart()`   | 点图（克利夫兰点图） |
| `stripchart()` | 一维散点图           |
| `image()`      | 矩阵方格图           |
| `contour()`    | 等高线图             |


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
plot(aq[, 2:5])
pairs(aq[, 2:5])
hist(aq$Ozone)
barplot(aq$Ozone)
boxplot(aq$Ozone)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip: 常见作图函数
    
    1. 理解 `image()` 函数做的矩阵方格图的含义。
    1. 做一张等高线图。


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
example()
demo()
~~~~~~~~~~~~~~~~~~~~~~~~~~~

## 细节调整


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
plot(aq$Ozone, axes = FALSE)
axis(1)
axis(2)
axis(3, 
     at = c(10, 40, 120), 
     labels = c(30^2, log(40), 60^0.5))
axis(4)
box()
~~~~~~~~~~~~~~~~~~~~~~~~~~~



~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
lines()
points()
abline()
axis()
legend()
text()
mtext()
expression()
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip: 低级作图函数
    
    1. 为 `income.level` ~ `price.index` 散点图添加图例，来说明当一个数据点对应的 market.potential $\geq$ 13 时画成红色, 否则为绿色。
    2. 为上图添加一条 `price.index` = 4.5 的水平线，颜色为蓝色。
    3. 在上述水平线的上方添加蓝色文字 "price.index = 4.5"。

## 多图布局



~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
plot(aq$Solar.R, aq$Temp, pch = 18, col = 'red')
points(aq$Solar.R, aq$Ozone, pch = 18, col = 'blue')
legend('topleft', legend = c('Ozone', "Temperature"), col = c("blue", "red"), pch = 18)


plot(aq$Solar.R, aq$Temp, pch = 18, col = 'red')
par(new = TRUE)
plot(aq$Solar.R, aq$Ozone, pch = 18, col = 'blue')
legend('topleft', legend = c('Ozone', "Temperature"), col = c("blue", "red"), pch = 18)

par(mfrow = c(1, 2))
plot(aq$Solar.R, aq$Temp, pch = 18, col = 'red')
plot(aq$Solar.R, aq$Ozone, pch = 18, col = 'blue')
~~~~~~~~~~~~~~~~~~~~~~~~~~~


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
layout(matrix(1:6, 2), widths = c(1, 1, 3), heights = c(1, 2))
layout.show(6)
plot(aq$Solar.R, aq$Temp, pch = 18, col = 'red')
plot(1, type = 'n', axes = FALSE, xlab = '', ylab = '')
plot(1, type = 'n', axes = FALSE, xlab = '', ylab = '')
plot(1, type = 'n', axes = FALSE, xlab = '', ylab = '')
plot(1, type = 'n', axes = FALSE, xlab = '', ylab = '')
plot(aq$Solar.R, aq$Ozone, pch = 18, col = 'blue')
~~~~~~~~~~~~~~~~~~~~~~~~~~~

## 保存图片



~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
pdf()
png()
jpg()
dev.off()
~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Tip: 作图
    
    1. 以 `income` 数据为例，任意做两张图，将他们以上述四种布局呈现。
    2. 将上图保存为 pdf 文件。

## 其他作图


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
install.packages(c('ggplot2', 'lattice', 'plotrix'))

require(ggplot2)
example(qplot)

require(lattice)
demo(lattice)

require(plotrix)
demo(plotrix)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

# 扩展包

## 什么是扩展包

![](https://pzhao.org/image/film-nezha.png)

就好比：

- MatLab: 工具箱（toolboxes）
- python: 库（libraries）
- MS Office: 模块（modules）
- Chrome: 插件（add-ons/plugins）
- CRAN 上有超过 16,000 个扩展包，GitHub 上有无数个。


## 扩展包示例

### 财富


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
install.packages("fortunes")
require(fortunes)
fortune()
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### 唐诗


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
install.packages('sinx')
require(sinx)
tsh <- read.sinxs(lib = "tangshi")
sinx(sinxs.data = tsh)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### 拼音


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
install.packages('pinyin')
require(pinyin)
py('华南理工', dic = pydic(dic = "pinyin2"))
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### plotrix


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
install.packages('plotrix')
require(plotrix)
demo(plotrix)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### ggplot2


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
install.packages('ggplot2')
require(ggplot2)
example(qplot)
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### R markdown

R Markdown 工作流程（《学 R》）.

![](images/rmarkdown.png)


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
install.packages('rmd')
~~~~~~~~~~~~~~~~~~~~~~~~~~~

RStudio - File - New File - R Markdown.


CRAN 上的 R 扩展包 ([image source](https://revolution-computing.typepad.com/.a/6a010534b1db25970b01b8d2594d25970c-pi))：

![](images/r_pkg_growth.png)

下载最多的 R 扩展包([image source](https://www.kdnuggets.com/wp-content/uploads/top-20-r-packages-downloads.jpg))：

![](images/top-20-r-packages-downloads.jpg)

### 引用扩展包


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
citation('plotrix')
citation('ggplot2')
citation('pinyin')
citation('sinx')
~~~~~~~~~~~~~~~~~~~~~~~~~~~

### 选用扩展包


1. 任务视图：https://cran.r-project.org/web/views/
2. 搜索引擎
3. 口碑
4. 参考文献

# 作业

!!! Tips: 禽流感数据
    
    1. 下载数据文件：<https://pzhao.org/data/birdflu.xls>.
    2. 将该数据读入 R。
    3. 这个数据表有多少行，多少列？
    4. 各列的列名称是什么？数据结构是什么？
    5. 数据显示中国 2006 年有多少病例？
    5. 这些国家在 2003 和 2005 年的病例总和分别是多少？
    6. 各国累计病例是多少？将累计病例数作为新的一列插入表中。
    7. 哪个国家累计病例数最多？哪个国家最少？
    8. 所有国家每年的病例总和是多少？
    9. 计算各年所有国家中病例数的平均值、最大值、最小值、中位数。
    10. 做数据概览。
    12. 保存数据。


!!! Tips: 安装扩展包
    
    
    ```r
    # from CRAN (something like peer reviewed)
    install.packages("remotes") # for installation from github
    install.packages('tinytex') # for compling LaTeX to pdf
    require(tinytex)
    install_tinytex()
    
    # from github (something like grey papers or self-published)
    require(remotes)
    install_github('pzhaonet/xjtlu')
    install_github('pzhaonet/rosr')
    ```


!!! Tips: 处理你自己的数据
    
    1. 新建一个项目
    1. 将你的数据读入 R
    1. 数据概览和计算
    1. 做图，并保存为 pdf 文件
    1. 从 CRAN 扩展包任务视图里，查找感兴趣的扩展包，安装并试用。



<!--
# Furthur Readings

![*A beginner's Guide to R*](https://images.gr-assets.com/books/1348830965l/6693811.jpg)


![*ggplot2 - Elegant Graphics for Data Analysis*](https://i.imgur.com/ICvLmEQ.jpg)

# Questions and Discussions

## Help


- F1
- [stackoverflow](https://stackoverflow.com/questions/tagged/r)
- [capital of statistics (in Chinese)](https://d.cosx.org/t/r)

## How to ask questions

- Search before asking: Google `keywords + r (+ cran) (+ stackoverflow)`

- If you have to ask, describe

  1. what you want to get
  2. what you have tried
  3. your data sample, your reproducible codes and session information


~~~~~~~~~~~~~~~~~~~~~~~~~~~r linenumbers
sessionInfo()
~~~~~~~~~~~~~~~~~~~~~~~~~~~

-->
<!-- Markdeep js: -->
<script src="D:/Program Files/R/R-4.0.3/library/deepdown/js/deepdown-doc.js" charset="utf-8"></script>
<script>markdeepOptions={inlineCodeLang:"R", tocStyle:"short"};</script>

<!-- FALLBACK: -->
<style class="fallback">body{visibility:hidden;white-space:pre;font-family:monospace}</style>

<script>window.alreadyProcessedMarkdeep||(document.body.style.visibility="visible")</script>

<!-- Inverse the color: -->
<style>
.md .inverse svg.diagram {
  background: #333;
  stroke: #FFF;
  fill: #FFF;
}

.md .inverse svg.diagram .opendot {
  fill: #333;
}
</style>

<!-- Markdeep: --><style class="fallback">body{visibility:hidden}</style><script src="https://pzhao.org/js/deepdown-doc.js?" charset="utf-8"></script>
